import os, json
import discord
from discord.ext import commands
import random
import asyncio

# Intents à¸•à¹‰à¸­à¸‡à¹€à¸›à¸´à¸” message_content à¸”à¹‰à¸§à¸¢
intents = discord.Intents.all()
intents.message_content = True
CONFIG_FILE = "allowed_roles.json"
temp_allowed_users: dict[int, set[int]] = {}

# à¸ªà¸£à¹‰à¸²à¸‡ Bot object
bot = commands.Bot(command_prefix='~', intents=intents)

# à¹€à¸Šà¹‡à¸„à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡ à¹€à¸Šà¹ˆà¸™ à¸›à¸´à¸”à¸«à¸¹, à¸›à¸´à¸”à¹„à¸¡à¸„à¹Œ, à¹€à¸•à¸°, disconnect, timeout

def has_high_permissions(member: discord.Member):
    perms = member.guild_permissions
    return any([
        perms.mute_members,
        perms.move_members,
        perms.deafen_members,
        perms.kick_members,
    ])

# à¸à¸³à¸«à¸™à¸”à¹ƒà¸«à¹‰à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§
async def revoke_temp_after(guild_id: int, user_id: int, delay: int = 13):
    await asyncio.sleep(delay)
    temp_allowed_users.get(guild_id, set()).discard(user_id)

# à¸šà¸¥à¹‡à¸­à¸ ~ à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸£à¸°à¸”à¸±à¸šà¸ªà¸¹à¸‡ à¸«à¸£à¸·à¸­à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§ (à¸¢à¸à¹€à¸§à¹‰à¸™ ~info, ~listcmd)
@bot.event
async def on_message(msg: discord.Message):
    if msg.author.bot:
        return

    gid = msg.guild.id
    uid = msg.author.id
    content_lower = msg.content.lower()

    if content_lower == "allowmyrole":
        temp_allowed_users.setdefault(gid, set()).add(uid)
        await msg.channel.send(f"âœ… {msg.author.mention} à¹ƒà¸Šà¹‰ `~` à¹„à¸”à¹‰ 7 à¸§à¸´à¸™à¸²à¸—à¸µ!")
        bot.loop.create_task(revoke_temp_after(gid, uid))
        return

    bypass_commands = ["~info", "~listcmd"]
    if msg.content.startswith("~") and not any(msg.content.lower().startswith(cmd) for cmd in bypass_commands):
        has_temp = uid in temp_allowed_users.get(gid, set())
        has_special_perm = has_high_permissions(msg.author)

        if not (has_temp or has_special_perm):
            try:
                await msg.delete()
            except discord.HTTPException:
                pass
            return

    await bot.process_commands(msg)

@bot.event
async def on_ready():
    print(f"âœ… Bot à¸žà¸£à¹‰à¸­à¸¡à¹à¸¥à¹‰à¸§: {bot.user}")

# à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹„à¸¡à¹ˆà¸ˆà¸³à¸à¸±à¸”à¸ªà¸´à¸—à¸˜à¸´à¹Œ
@bot.command()
async def info(ctx):
    await ctx.send("This bot is made by jazaza and also generated by chatGPT 4o (Cuz I dunno python bro)")

@bot.command()
async def Listcmd(ctx):
    await ctx.send(
        "**ðŸ“œ Available Commands:**\n\n"
        "**~listmembers** - à¹à¸ªà¸”à¸‡à¸Šà¸·à¹ˆà¸­à¸ªà¸¡à¸²à¸Šà¸´à¸à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ\n"
        "**~play** - à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¸­à¸à¹‚à¸«à¸¡à¸”à¸ªà¸¸à¹ˆà¸¡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™: RANK (à¹€à¸¥à¸·à¸­à¸ 1 à¸„à¸™à¸ˆà¸²à¸à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5 à¸„à¸™à¹ƒà¸™ VC) à¸«à¸£à¸·à¸­ 5V5 (à¹à¸šà¹ˆà¸‡à¸—à¸µà¸¡à¹à¸¥à¸°à¸¢à¹‰à¸²à¸¢à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¹‰à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´)\n"
        "**~winner** - à¸ªà¸¸à¹ˆà¸¡à¸œà¸¹à¹‰à¸Šà¸™à¸° 1 à¸„à¸™à¸ˆà¸²à¸à¸œà¸¹à¹‰à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸«à¹‰à¸­à¸‡ VC à¹€à¸”à¸µà¸¢à¸§à¸à¸±à¸šà¸„à¸¸à¸“\n"
        "**~pick** - à¸ªà¸¸à¹ˆà¸¡à¸ˆà¸³à¸™à¸§à¸™ N à¸„à¸™à¸ˆà¸²à¸ VC à¹‚à¸”à¸¢à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸„à¸™à¸à¸³à¸«à¸™à¸”à¸ˆà¸³à¸™à¸§à¸™\n"
        "**~info** - à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¸šà¸­à¸—à¹à¸¥à¸°à¸—à¸µà¹ˆà¸¡à¸²à¸‚à¸­à¸‡à¹‚à¸„à¹‰à¸”\n"
        "**allowmyrole** - à¸žà¸´à¸¡à¸žà¹Œà¹ƒà¸™à¹à¸Šà¸—à¹€à¸žà¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¸ªà¸´à¸—à¸˜à¸´à¹Œà¹ƒà¸Šà¹‰ `~` à¹„à¸”à¹‰à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§ 7 à¸§à¸´à¸™à¸²à¸—à¸µ à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸™à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ role à¸—à¸µà¹ˆà¸­à¸™à¸¸à¸à¸²à¸•\n\n"
        "ðŸ›¡ï¸ *à¹€à¸‰à¸žà¸²à¸°à¸„à¸³à¸ªà¸±à¹ˆà¸‡ `~info` à¹à¸¥à¸° `~listcmd` à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™à¸—à¸µà¹ˆà¸—à¸¸à¸à¸„à¸™à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹€à¸ªà¸¡à¸­*\n"
        "ðŸ” *à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸­à¸·à¹ˆà¸™à¸ˆà¸°à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¹€à¸‰à¸žà¸²à¸°à¸„à¸™à¸—à¸µà¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸ªà¸µà¸¢à¸‡ à¸«à¸£à¸·à¸­à¹ƒà¸Šà¹‰ `allowmyrole` à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™*"
    )

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­à¸‚à¸­à¸‡à¹‚à¸„à¹‰à¸” (play, winner, pick, TeamSelector, VCSelector à¸¯à¸¥à¸¯) à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
# ...

# Bot startup
@bot.command()
async def listmembers(ctx):
    members = ctx.guild.members
    names = [m.name for m in members if not m.bot]
    await ctx.send("ðŸ‘¥ Members: " + ", ".join(names))

# ======================
# à¸£à¸°à¸šà¸šà¸ªà¸¸à¹ˆà¸¡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™
# ======================

class VCSelector(discord.ui.View):
    def __init__(self, members):
        super().__init__(timeout=60)
        self.members = members

    @discord.ui.select(placeholder="ðŸ”ˆ Select VC for Team 1 & 2", min_values=2, max_values=2, options=[])
    async def select_vc(self, interaction: discord.Interaction, select: discord.ui.Select):
        vc1 = interaction.guild.get_channel(int(select.values[0]))
        vc2 = interaction.guild.get_channel(int(select.values[1]))

        if not self.members:
            await interaction.response.send_message("âŒ No members to sort", ephemeral=True)
            return

        random.shuffle(self.members)
        half = len(self.members) // 2
        team1 = self.members[:half]
        team2 = self.members[half:]

        for m in team1:
            try: await m.move_to(vc1)
            except: pass
        for m in team2:
            try: await m.move_to(vc2)
            except: pass

        await interaction.response.send_message(
            f"âœ… Moved to VC\nðŸ”ˆ **{vc1.name}**: " + ", ".join(m.display_name for m in team1) +
            f"\nðŸ”ˆ **{vc2.name}**: " + ", ".join(m.display_name for m in team2)
        )
        self.stop()

class TeamSelector(discord.ui.View):
    @discord.ui.button(label="RANK", style=discord.ButtonStyle.primary)
    async def rank_button(self, interaction: discord.Interaction, _):
        members = [m for m in interaction.guild.members if not m.bot and m.voice]
        if not members:
            await interaction.response.send_message("âŒ No one in VC", ephemeral=True)
            return
        group = random.sample(members, 5) if len(members) > 5 else members
        winner = random.choice(group)
        await interaction.response.send_message(f"ðŸŽ¯ RANK winner: {winner.mention}")

    @discord.ui.button(label="5V5", style=discord.ButtonStyle.success)
    async def v5_button(self, interaction: discord.Interaction, _):
        members = [m for m in interaction.guild.members if not m.bot and m.voice]
        vcs = interaction.guild.voice_channels
        if len(vcs) < 2:
            await interaction.response.send_message("âŒ Need 2+ VC channels", ephemeral=True)
            return
        options = [discord.SelectOption(label=vc.name, value=str(vc.id)) for vc in vcs]
        view = VCSelector(members)
        view.select_vc.options = options
        await interaction.response.send_message("ðŸ”½ Select VC channels:", view=view, ephemeral=True)

@bot.command()
async def play(ctx):
    await ctx.send("ðŸŽ® Select mode:", view=TeamSelector())

@bot.command()
async def winner(ctx):
    vc = ctx.author.voice.channel if ctx.author.voice else None
    if not vc:
        await ctx.send("âŒ Join VC first")
        return
    members = [m for m in vc.members if not m.bot]
    if not members:
        await ctx.send("âŒ No human members in VC")
        return
    win = random.choice(members)
    await ctx.send(f"ðŸŽ‰ Winner in **{vc.name}**: {win.mention}")

@bot.command()
async def pick(ctx):
    vc = ctx.author.voice.channel if ctx.author.voice else None
    if not vc:
        await ctx.send("âŒ Join VC first")
        return
    members = [m for m in vc.members if not m.bot]
    await ctx.send("How many people to pick? (reply within 30s)")

    def check(m): return m.author == ctx.author and m.channel == ctx.channel and m.content.isdigit()
    try:
        msg = await bot.wait_for("message", timeout=30, check=check)
        n = max(1, min(int(msg.content), len(members)))
        chosen = random.sample(members, n)
        await ctx.send("ðŸŽ¯ Selected:\n" + "\n".join(m.mention for m in chosen))
    except asyncio.TimeoutError:
        await ctx.send("â° Time out!")

# ======================
# START BOT
# ======================
bot.run()
